<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>í†µí•© ìŠ¤ë§ˆíŠ¸ ì¶œì„ ì‹œìŠ¤í…œ</title>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; max-width: 1100px; margin: 0 auto; background-color: #f4f4f9; }
    h1, h3, h4 { color:#333; margin: 10px 0; }
    .card { background:#fff; border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:10px; box-shadow:0 2px 4px rgba(0,0,0,0.07); }
    .row { display:flex; gap:12px; flex-wrap: wrap; }
    .col { flex:1; min-width: 260px; }
    .muted { color:#777; }
    .pill { display:inline-block; padding:2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #ddd; background:#fafafa; margin-left:6px; }
    .noti-unread { background-color:#fffbe6; border-left: 4px solid #ff9800; }
    .noti-read { opacity: 0.65; }

    /* ë²„íŠ¼ */
    button { cursor:pointer; border:none; border-radius:6px; padding:8px 14px; font-weight:700; }
    .btn-primary { background:#008CBA; color:#fff; }
    .btn-success { background:#4CAF50; color:#fff; }
    .btn-danger  { background:#f44336; color:#fff; }
    .btn-warning { background:#ff9800; color:#fff; }
    .btn-dark    { background:#555; color:#fff; }
    .btn-ghost   { background:#f5f5f5; color:#333; border:1px solid #ddd; }

    input, select, textarea { width: 100%; box-sizing:border-box; padding: 8px; margin: 6px 0; border:1px solid #ccc; border-radius:6px; }
    textarea { min-height: 70px; resize: vertical; }

    /* íƒ­ */
    .tab { overflow:hidden; border-bottom:1px solid #ccc; margin: 18px 0 20px; }
    .tab button { background:inherit; float:left; border:none; outline:none; padding: 14px 16px; color:#666; font-weight:800; border-radius:0; }
    .tab button:hover { background:#ddd; }
    .tab button.active { background:#fff; border:1px solid #ccc; border-bottom:none; color:#000; }
    .tab-content { display:none; }

    /* í…Œì´ë¸” */
    table { width:100%; border-collapse: collapse; margin-top: 10px; font-size: 0.92em; }
    th, td { border:1px solid #ddd; padding: 8px; text-align:center; vertical-align: middle; }
    th { background:#f2f2f2; }
    td.left { text-align:left; }

    .topbar { display:flex; justify-content: space-between; align-items: center; gap:12px; }
    .logout-btn { padding: 7px 12px; }

    .badge-green { color:#2e7d32; font-weight:800; }
    .badge-orange { color:#ef6c00; font-weight:800; }
    .badge-red { color:#c62828; font-weight:800; }
    .badge-blue { color:#1565c0; font-weight:800; }

    /* [ì¶”ê°€ë¨] ìŠ¤ë§ˆíŠ¸ ìŠ¤ì¼€ì¤„ëŸ¬ìš© ë±ƒì§€ ìŠ¤íƒ€ì¼ */
    .tag-holiday { background:#ffebee; color:#c62828; border:1px solid #ffcdd2; padding:2px 6px; border-radius:4px; font-size:11px; margin-right:5px; font-weight: bold; }
    .tag-date { background:#e3f2fd; color:#1565c0; border:1px solid #bbdefb; padding:2px 6px; border-radius:4px; font-size:11px; margin-right:5px; }

    .hr { height:1px; background:#eee; margin: 14px 0; }
    .tiny { font-size: 12px; }
    .right { text-align:right; }

    /* ì±„íŒ…ë°© ìŠ¤íƒ€ì¼ */
    .chat-container { display:flex; height: 500px; border:1px solid #ddd; border-radius:8px; overflow:hidden; background:#fff; }
    .chat-sidebar { width: 280px; background:#f9f9f9; border-right:1px solid #ddd; display:flex; flex-direction:column; }
    .chat-main { flex:1; display:flex; flex-direction:column; background:#fff; }
    .user-list { flex:1; overflow-y:auto; }
    .user-item { padding:12px; border-bottom:1px solid #eee; cursor:pointer; }
    .user-item:hover, .user-item.active { background:#e3f2fd; }
    .chat-messages { flex:1; overflow-y:auto; padding:15px; background:#f0f2f5; display:flex; flex-direction:column; gap:10px; }
    .message-bubble { max-width:70%; padding:10px 14px; border-radius:15px; font-size:14px; line-height:1.4; position:relative; word-wrap: break-word; }
    .msg-mine { align-self:flex-end; background:#fee500; color:#000; border-top-right-radius: 0; }
    .msg-other { align-self:flex-start; background:#fff; border:1px solid #ddd; border-top-left-radius: 0; }
    .msg-info { font-size:11px; color:#888; margin-bottom:2px; }
    .chat-input-area { padding:10px; border-top:1px solid #ddd; display:flex; gap:10px; background:#fff; }
  </style>
</head>
<body>
  <h1>ğŸ« í†µí•© ìŠ¤ë§ˆíŠ¸ ì¶œì„ ì‹œìŠ¤í…œ</h1>

  {% if user %}
    <div class="topbar">
      <h3>
        ë°˜ê°‘ìŠµë‹ˆë‹¤, <span style="color:#008CBA;">{{ user.name }}</span>
        <small class="muted">({{ user.role }})</small>
      </h3>
      <button class="btn-dark logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div class="tab">
      <button class="tablinks active" onclick="openTab(event,'Lecture')">ğŸ“š ê°•ì˜/ì¶œì„</button>
      <button class="tablinks" onclick="openTab(event,'Excuse')">ğŸ“ ê³µê²°</button>
      <button class="tablinks" onclick="openTab(event,'Notice')">ğŸ“¢ ê³µì§€</button>
      <button class="tablinks" onclick="openTab(event,'Offvote')">ğŸ“Š íˆ¬í‘œ</button>
      <button class="tablinks" onclick="openTab(event,'Report')">ğŸ“ˆ ë¦¬í¬íŠ¸</button>
      <button class="tablinks" onclick="openTab(event,'Message')">ğŸ’¬ ë©”ì‹œì§€</button>
      
      {% if user.role == 'admin' %}
        <button class="tablinks" onclick="openTab(event,'Admin')">ğŸ› ï¸ ê´€ë¦¬ì</button>
        <button class="tablinks" onclick="openTab(event,'Audit')">ğŸ”’ ê°ì‚¬ ë¡œê·¸</button>
      {% endif %}
      <button class="tablinks" onclick="openTab(event,'Notification')">ğŸ”” ì•Œë¦¼</button>
    </div>

    <div id="Lecture" class="tab-content" style="display:block;">
      <div class="card">
        <h4>ğŸ“‹ ê°•ì˜ ëª©ë¡</h4>
        <div id="courseList" class="muted">ë¡œë”© ì¤‘...</div>
      </div>
    </div>

    <div id="Excuse" class="tab-content">
      {% if user.role == 'student' %}
        <div class="card">
          <h4>ğŸ“ ê³µê²° ì‹ ì²­í•˜ê¸°</h4>
          <form id="excuseForm" enctype="multipart/form-data">
            <input type="text" name="reason" placeholder="ì‚¬ìœ  (ì˜ˆ: ë³‘ì› ì§„ë£Œ)" required/>
            <input type="file" name="file" />
            <button type="submit" class="btn-success">ì‹ ì²­</button>
          </form>
        </div>

        <div class="card">
          <h4>ğŸ“‚ ë‚´ ì‹ ì²­ ë‚´ì—­</h4>
          <div id="myExcuseList" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      {% endif %}

      {% if user.role == 'instructor' or user.role == 'admin' %}
        <div class="card">
          <h4>ğŸ‘¨â€ğŸ« ê²°ì¬ ëŒ€ê¸° ëª©ë¡</h4>
          <div id="pendingExcuseList" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      {% endif %}
    </div>

    <div id="Notice" class="tab-content">
      {% if user.role == 'instructor' or user.role == 'admin' %}
        <div class="card">
          <h4>ğŸ“¢ ê³µì§€ ì‘ì„±</h4>
          <form id="noticeForm">
            <label class="tiny muted">ëŒ€ìƒ ê°•ì˜</label>
            <select id="noticeCourseSelect" name="courseId" required>
              <option value="">ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            </select>
            <input type="text" name="title" placeholder="ì œëª©" required />
            <textarea name="content" placeholder="ë‚´ìš©" required></textarea>
            <button type="submit" class="btn-primary">ë“±ë¡</button>
          </form>
        </div>
      {% endif %}

      <div class="card">
        <h4>ğŸ“¢ ê³µì§€ ëª©ë¡</h4>
        <div id="noticeList" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <div id="Offvote" class="tab-content">
      {% if user.role == 'instructor' or user.role == 'admin' %}
        <div class="card">
          <h4>ğŸ“Š íˆ¬í‘œ ë§Œë“¤ê¸°</h4>
          <form id="offvoteForm">
            <label class="tiny muted">ëŒ€ìƒ ê°•ì˜</label>
            <select id="offvoteCourseSelect" name="courseId">
              <option value="">(ì„ íƒ) ê°•ì˜ ì§€ì •</option>
            </select>
            <input type="text" name="title" placeholder="íˆ¬í‘œ ì œëª©" required />
            <textarea name="description" placeholder="ì„¤ëª…(ì„ íƒ)"></textarea>
            <textarea name="options" placeholder="ì„ íƒì§€ (ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ ê°œ ì…ë ¥)" required></textarea>
            <button type="submit" class="btn-primary">ìƒì„±</button>
          </form>
        </div>
      {% endif %}

      <div class="card">
        <h4>ğŸ“Š íˆ¬í‘œ ëª©ë¡</h4>
        <div id="offvoteList" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

    <div id="Report" class="tab-content">
      <div class="card">
        <h4>ğŸ“ˆ ì¶œì„ ë¦¬í¬íŠ¸</h4>
        <div class="tiny muted">
          * ìˆ˜ì—… ì‹œì‘ í›„ 10ë¶„ì´ ì§€ë‚˜ë©´ ì§€ê° ì²˜ë¦¬ë©ë‹ˆë‹¤. (ì§€ê° 3íšŒ = ê²°ì„ 1íšŒ)
        </div>

        <div style="margin-top:10px;">
          <select id="reportCourseSelect" onchange="loadAttendanceReport()">
            <option value="">ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </div>

        <div id="reportResult" class="muted" style="margin-top:10px;">
          ê°•ì˜ë¥¼ ì„ íƒí•˜ë©´ ë¦¬í¬íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.
        </div>
      </div>

      {% if user.role == 'admin' %}
        <div class="card">
          <h4>ğŸ§¾ ê´€ë¦¬ì ë¦¬í¬íŠ¸ (ìš”ì•½)</h4>
          <button class="btn-primary" onclick="loadAdminReport()">ìš”ì•½ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <div id="adminReportBox" class="muted" style="margin-top:10px;">-</div>
        </div>
      {% endif %}
    </div>

    <div id="Message" class="tab-content">
      <div class="card" style="padding:0; overflow:hidden;">
        <div style="padding:15px; border-bottom:1px solid #ddd; background:#f8f9fa;">
          <h4>ğŸ’¬ 1:1 ë©”ì‹œì§€ (ì¶œì„ ì •ì •/ë¬¸ì˜)</h4>
          <select id="msgCourseSelect" onchange="loadChatTargets()" style="max-width:300px;">
            <option value="">ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </div>
        
        <div class="chat-container">
          <div class="chat-sidebar">
            <div style="padding:10px; border-bottom:1px solid #eee; font-weight:bold; color:#555;">
              ëŒ€í™” ìƒëŒ€
            </div>
            <div id="msgTargetList" class="user-list">
              <div style="padding:15px; color:#999; font-size:13px; text-align:center;">ê°•ì˜ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</div>
            </div>
          </div>

          <div class="chat-main">
            <div id="chatBox" class="chat-messages">
              <div style="text-align:center; color:#999; margin-top:50px;">
                ì™¼ìª½ì—ì„œ ëŒ€í™” ìƒëŒ€ë¥¼ ì„ íƒí•˜ë©´<br>ì±„íŒ…ì´ ì‹œì‘ë©ë‹ˆë‹¤.
              </div>
            </div>
            <div class="chat-input-area">
              <input type="text" id="msgInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš” (Enterë¡œ ì „ì†¡)" onkeypress="if(event.key==='Enter') sendMsg()">
              <button class="btn-primary" onclick="sendMsg()">ì „ì†¡</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if user.role == 'admin' %}
      <div id="Admin" class="tab-content">
        <div class="card" style="border-left: 5px solid #673AB7; margin-bottom: 20px;">
          <h4 style="color:#673AB7;">ğŸ“š ê³¼ëª© ê°œì„¤ (ê´€ë¦¬ì ì „ìš©)</h4>
          <div class="row">
            <div class="col">
              <label class="tiny muted">ê³¼ëª©ëª…</label>
              <input id="newCourseName" type="text" placeholder="ì˜ˆ: ì›¹í”„ë¡œê·¸ë˜ë° ê¸°ì´ˆ" />
            </div>
            <div class="col">
              <label class="tiny muted">ë‹´ë‹¹ êµìˆ˜</label>
              <select id="newCourseInstructor">
                <option value="">êµìˆ˜ë‹˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label class="tiny muted">í•™ê³¼</label>
              <select id="newCourseDept">
                <option value="">í•™ê³¼ ì„ íƒ (ì„ íƒì‚¬í•­)</option>
              </select>
            </div>
            <div class="col">
              <label class="tiny muted">í•™ê¸°</label>
              <select id="newCourseSem">
                <option value="">í•™ê¸° ì„ íƒ (ì„ íƒì‚¬í•­)</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px; background:#f5f5f5; padding:10px; border-radius:6px; border:1px solid #ddd;">
            <div class="col">
              <label class="tiny muted" style="font-weight:bold; color:#555;">ğŸ“… ìˆ˜ì—… ìš”ì¼</label>
              <select id="newCourseDay">
                <option value="1">ì›”ìš”ì¼</option>
                <option value="2">í™”ìš”ì¼</option>
                <option value="3">ìˆ˜ìš”ì¼</option>
                <option value="4">ëª©ìš”ì¼</option>
                <option value="5">ê¸ˆìš”ì¼</option>
                <option value="6">í† ìš”ì¼</option>
              </select>
            </div>
            <div class="col">
              <label class="tiny muted" style="font-weight:bold; color:#555;">ğŸš€ ê°œê°• ì‹œì‘ì¼ (1ì£¼ì°¨)</label>
              <input id="newCourseStart" type="date" value="2025-09-01" />
            </div>
          </div>
      
          <button class="btn-primary" style="margin-top:10px; width:100%; background-color:#673AB7;" onclick="createAdminCourse()">ê³¼ëª© ê°œì„¤ ë° êµìˆ˜ ë°°ì •</button>
        </div>

        <div class="card" style="border-left: 5px solid #008CBA; margin-bottom: 20px;">
          <h4 style="color:#008CBA;">ğŸ‘¥ ì‚¬ìš©ì ë“±ë¡ (ê´€ë¦¬ììš©)</h4>
          <div class="row">
            <div class="col">
              <input id="newUserNameUser" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)" />
            </div>
            <div class="col">
              <input id="newUserEmail" placeholder="ì´ë©”ì¼" />
            </div>
            <div class="col">
              <input id="newUserPwd" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <input id="newUserStdId" placeholder="í•™ë²ˆ/êµë²ˆ (ì„ íƒ)" />
            </div>
            <div class="col">
              <select id="newUserRole">
                <option value="student">í•™ìƒ (Student)</option>
                <option value="instructor">êµìˆ˜ (Instructor)</option>
              </select>
            </div>
            <div class="col">
              <button class="btn-primary" style="width:100%; margin-top:6px;" onclick="createAdminUser()">ì‚¬ìš©ì ë“±ë¡</button>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="card">
              <h4>ğŸ·ï¸ í•™ê³¼(Departments)</h4>
              <div class="row">
                <div class="col">
                  <input id="deptName" placeholder="í•™ê³¼ëª… (í•„ìˆ˜)"/>
                  <input id="deptCode" placeholder="í•™ê³¼ì½”ë“œ (ì„ íƒ)"/>
                  <button class="btn-success" onclick="createDepartment()">í•™ê³¼ ìƒì„±</button>
                </div>
              </div>
              <div class="hr"></div>
              <button class="btn-ghost" onclick="loadDepartments()">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
              <div id="deptList" class="muted" style="margin-top:10px;">-</div>
            </div>
          </div>

          <div class="col">
            <div class="card">
              <h4>ğŸ—“ï¸ í•™ê¸°(Semesters)</h4>
              <input id="semName" placeholder="í•™ê¸°ëª… (ì˜ˆ: 2025-2)"/>
              <input id="semStart" type="date" placeholder="ì‹œì‘ì¼"/>
              <input id="semEnd" type="date" placeholder="ì¢…ë£Œì¼"/>
              <button class="btn-success" onclick="createSemester()">í•™ê¸° ìƒì„±</button>
              <div class="hr"></div>
              <button class="btn-ghost" onclick="loadSemesters()">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
              <div id="semList" class="muted" style="margin-top:10px;">-</div>
            </div>
          </div>

          <div class="col">
            <div class="card">
  <h4>âš™ï¸ ì‹œìŠ¤í…œ ì„¤ì •</h4>
  <div class="tiny muted" style="margin-bottom:12px;">
    ì§€ê°ì´ ëª‡ ë²ˆ ìŒ“ì´ë©´ ê²°ì„ìœ¼ë¡œ ì¹ ì§€, ê²°ì„ì´ ëª‡ ë²ˆì´ë©´ ê²½ê³ ë¥¼ ì¤„ì§€ ì„¤ì •í•©ë‹ˆë‹¤.
  </div>
  <div style="background:#f9f9f9; padding:12px; border-radius:8px; border:1px solid #eee;">
    <label class="tiny" style="font-weight:bold; color:#555;">1. ì§€ê° ë³€í™˜ ê¸°ì¤€</label>
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
      <span>ì§€ê°</span>
      <input type="number" id="lateToAbsentInput" placeholder="3" style="width:60px; text-align:center; margin:0;">
      <span>íšŒ = ê²°ì„ 1íšŒ</span>
    </div>
    <label class="tiny" style="font-weight:bold; color:#555;">2. Fí•™ì  ê²½ê³  ê¸°ì¤€</label>
    <div style="display:flex; align-items:center; gap:8px;">
      <span>ê²°ì„</span>
      <input type="number" id="warningThresholdInput" placeholder="3" style="width:60px; text-align:center; margin:0;">
      <span>íšŒ ì´ìƒ ì‹œ ê²½ê³ </span>
    </div>
  </div>
  <div style="margin-top:12px;">
    <button class="btn-warning" style="width:100%" onclick="saveSystemSettings()">ê·œì¹™ ì €ì¥</button>
  </div>
</div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="card">
              <h4>ğŸ‘¥ ì‚¬ìš©ì & ğŸ“š ê³¼ëª© ëª©ë¡</h4>
              
              <div id="courseEditCard" class="card" style="display:none; border-left: 5px solid #ff9800; background:#fff3e0; margin-bottom:15px;">
                <h4 style="color:#ef6c00;">âœï¸ ê³¼ëª© ìˆ˜ì •</h4>
                <input type="hidden" id="editCourseId">
                
                <label class="tiny muted">ê³¼ëª©ëª…</label>
                <input id="editCourseName" type="text" placeholder="ê³¼ëª©ëª…" style="background:#fff;">
                
                <div class="row">
                  <div class="col">
                    <label class="tiny muted">ë‹´ë‹¹ êµìˆ˜</label>
                    <select id="editCourseInstructor" style="background:#fff;"><option value="">ë¡œë”© ì¤‘...</option></select>
                  </div>
                  <div class="col">
                    <label class="tiny muted">í•™ê³¼</label>
                    <select id="editCourseDept" style="background:#fff;"><option value="">ë¡œë”© ì¤‘...</option></select>
                  </div>
                  <div class="col">
                    <label class="tiny muted">í•™ê¸°</label>
                    <select id="editCourseSem" style="background:#fff;"><option value="">ë¡œë”© ì¤‘...</option></select>
                  </div>
                </div>

                <div style="margin-top:10px; text-align:right;">
                  <button class="btn-warning" onclick="saveCourseChanges()">ìˆ˜ì • ì €ì¥</button>
                  <button class="btn-ghost" onclick="closeCourseEditor()">ì·¨ì†Œ</button>
                </div>
              </div>
              <div class="row" style="margin-top:10px;">
                <div class="col">
                  <button class="btn-ghost" onclick="loadAdminUsers()">ì‚¬ìš©ì ëª©ë¡</button>
                  <div id="adminUsersBox" class="muted" style="margin-top:10px;">-</div>
                </div>
                <div class="col">
                  <button class="btn-ghost" onclick="loadAdminCourses()">ê³¼ëª© ëª©ë¡</button>
                  <div id="adminCoursesBox" class="muted" style="margin-top:10px;">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="Audit" class="tab-content">
        <div class="card">
          <h4>ğŸ”’ ê°ì‚¬ ë¡œê·¸</h4>
          <div class="row">
            <div class="col">
              <input id="auditLimit" type="number" placeholder="limit (ê¸°ë³¸ 100)" />
            </div>
            <div class="col">
              <button class="btn-primary" onclick="loadAuditLogs()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
          </div>
          <div id="auditList" class="muted" style="margin-top:10px;">-</div>
        </div>
      </div>
    {% endif %}

    <div id="Notification" class="tab-content">
      <div class="card">
        <h4>ğŸ”” ë‚´ ì•Œë¦¼</h4>
        <div class="row">
          <div class="col">
            <button class="btn-primary" onclick="loadNotifications()">ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn-ghost" onclick="markAllNotificationsRead()">ëª¨ë‘ ì½ìŒ</button>
          </div>
        </div>
        <div id="notificationList" class="muted" style="margin-top:10px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
    </div>

  {% else %}
    <div class="card" style="text-align:center; margin-top:90px;">
      <h3>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</h3>
      <a href="/login"><button class="btn-primary" style="font-size:1.1em;">ë¡œê·¸ì¸</button></a>
      <div style="margin-top:10px;">
        <a href="/join" class="muted">íšŒì›ê°€ì…</a>
      </div>
    </div>
  {% endif %}

  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    const userRole = "{% if user %}{{ user.role }}{% else %}{% endif %}";
    const userId   = "{% if user %}{{ user.id }}{% else %}{% endif %}";

    function openTab(evt, tabName) {
      // 1. ëª¨ë“  íƒ­ ë‚´ìš© ìˆ¨ê¸°ê¸°
      const tabcontent = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }

      // 2. ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
      const tablinks = document.getElementsByClassName("tablinks");
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }

      // 3. ì„ íƒí•œ íƒ­ ë³´ì—¬ì£¼ê¸°
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";

      // â˜…â˜…â˜… [ì—¬ê¸°ê°€ í•µì‹¬!] ê´€ë¦¬ì íƒ­ì„ ëˆ„ë¥´ë©´, ë°ì´í„°ë¥¼ ê°•ì œë¡œ ê°€ì ¸ì˜¤ê²Œ ì‹œí‚µë‹ˆë‹¤. â˜…â˜…â˜…
      if (tabName === 'Admin') {
        console.log("ê´€ë¦¬ì íƒ­ í´ë¦­: ë°ì´í„° ë¡œë”© ì‹œì‘");
        loadAdminCourseOptions(); // êµìˆ˜, í•™ê³¼, í•™ê¸° ì„ íƒì°½ ì±„ìš°ê¸°
        loadAdminUsers();         // ì‚¬ìš©ì ëª©ë¡ ì±„ìš°ê¸°
        loadAdminCourses();       // ê³¼ëª© ëª©ë¡ ì±„ìš°ê¸°
        loadDepartments();        // í•™ê³¼ ëª©ë¡ ì±„ìš°ê¸°
        loadSemesters();          // í•™ê¸° ëª©ë¡ ì±„ìš°ê¸°
      }
    }

    async function logout() {
      try { await axios.post('/auth/logout'); }
      finally { location.href = '/login'; }
    }

    // ======================
    // ì´ˆê¸° ë¡œë”©
    // ======================
    if (userRole) {
      loadCourses();
      loadNotices();
      loadOffvotes();
      loadNotifications();

      if (userRole === 'student') loadMyExcuses();
      if (userRole === 'instructor' || userRole === 'admin') loadPendingExcuses();

      if (userRole === 'admin') {
        loadDepartments();
        loadSemesters();
        loadSystemRules();
        loadAdminCourseOptions();
      }
    }

    // ======================
    // ê°•ì˜
    // ======================
    async function loadCourses() {
      try {
        const res = await axios.get('/courses');
        const courses = res.data || [];
        const list = document.getElementById('courseList');

        if (!courses.length) {
          list.innerHTML = '<p class="muted">ë“±ë¡ëœ ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          fillCourseSelects([]);
          return;
        }

        list.innerHTML = courses.map(c => `
          <div class="card" style="border-left:5px solid #008CBA;">
            <div class="row" style="align-items:center;">
              <div class="col">
                <h3 style="margin:0;">ğŸ“š ${escapeHtml(c.name)}</h3>
                <div class="tiny muted">
                  êµìˆ˜: ${c.instructor ? escapeHtml(c.instructor.name) : '-'}
                  ${c.department ? `<span class="pill">í•™ê³¼: ${escapeHtml(c.department.name)}</span>` : ''}
                  ${c.semester ? `<span class="pill">í•™ê¸°: ${escapeHtml(c.semester.name)}</span>` : ''}
                </div>
              </div>
              <div class="col right">
                ${(userRole === 'instructor' || userRole === 'admin') ? 
                  `<button class="btn-success" style="margin-right:4px;" onclick="openEnrollManager(${c.id}, '${escapeHtml(c.name)}')">ğŸ‘¥ ìˆ˜ê°•ìƒ ê´€ë¦¬</button>` : ''}
                <button class="btn-primary" onclick="toggleSessions(${c.id})">ìˆ˜ì—… ëª©ë¡</button>
              </div>
            </div>
            <div id="enroll-box-${c.id}" style="display:none; margin-top:10px; background:#f1f8e9; padding:12px; border:1px solid #c5e1a5;"></div>
            <div id="sessions-${c.id}" style="display:none; margin-top:10px;"></div>
          </div>
        `).join('');

        fillCourseSelects(courses);
      } catch (err) {
        console.error(err);
        document.getElementById('courseList').innerHTML = '<p class="badge-red">ê°•ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
        fillCourseSelects([]);
      }
    }

    // â˜…â˜…â˜… [ìˆ˜ì •ë¨] ìˆ˜ê°•ìƒ ê´€ë¦¬: í•™ë²ˆ ì…ë ¥ ëŒ€ì‹  "ì „ì²´ í•™ìƒ ëª©ë¡" ë³´ì—¬ì£¼ê¸° â˜…â˜…â˜…
    async function openEnrollManager(courseId, courseName) {
      const box = document.getElementById(`enroll-box-${courseId}`);
      if (!box) return;

      if (box.style.display === 'block') {
        box.style.display = 'none';
        return;
      }

      box.style.display = 'block';
      box.innerHTML = `
        <div style="border-bottom:1px solid #c5e1a5; padding-bottom:8px; margin-bottom:8px;">
          <b>ğŸ‘¥ '${courseName}' ìˆ˜ê°•ìƒ ê´€ë¦¬</b>
        </div>
        
        <h5 class="muted" style="margin:5px 0;">âœ… í˜„ì¬ ë“±ë¡ëœ ìˆ˜ê°•ìƒ</h5>
        <div id="enroll-list-${courseId}" class="tiny">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

        <div class="hr" style="margin:15px 0;"></div>

        <h5 class="muted" style="margin:5px 0;">â• í•™ìƒ ì¶”ê°€ (ì „ì²´ ëª©ë¡)</h5>
        <button class="btn-primary" style="width:100%;" onclick="loadAllCandidates(${courseId})">í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <div id="candidate-list-${courseId}" style="margin-top:10px; max-height:200px; overflow-y:auto; border:1px solid #ddd; display:none;"></div>
      `;
      loadEnrolledStudents(courseId);
    }

    async function loadEnrolledStudents(courseId) {
      const listBox = document.getElementById(`enroll-list-${courseId}`);
      try {
        const res = await axios.get(`/enrollment/${courseId}`);
        const students = res.data || [];

        if (!students.length) {
          listBox.innerHTML = '<span class="muted">ë“±ë¡ëœ ìˆ˜ê°•ìƒì´ ì—†ìŠµë‹ˆë‹¤.</span>';
          return;
        }

        listBox.innerHTML = `
          <table style="background:#fff;">
            <thead><tr><th>ì´ë¦„</th><th>í•™ë²ˆ</th><th>ê´€ë¦¬</th></tr></thead>
            <tbody>
              ${students.map(s => `
                <tr>
                  <td>${escapeHtml(s.name)}</td>
                  <td>${escapeHtml(s.studentId)}</td>
                  <td><button class="btn-danger" style="padding:2px 6px; font-size:11px;" onclick="removeStudentFromCourse(${courseId}, ${s.id}, '${escapeHtml(s.name)}')">ì‚­ì œ</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        listBox.innerHTML = 'ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨';
      }
    }

    // â˜… [ì¶”ê°€] ì „ì²´ í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì™€ì„œ ë³´ì—¬ì£¼ê¸°
    async function loadAllCandidates(courseId) {
      const box = document.getElementById(`candidate-list-${courseId}`);
      box.style.display = 'block';
      box.innerHTML = '<div class="tiny muted" style="padding:5px;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

      try {
        const res = await axios.get('/enrollment/list/candidates');
        const students = res.data || [];

        if (!students.length) {
          box.innerHTML = '<div class="tiny muted" style="padding:5px;">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        box.innerHTML = `
          <table style="background:#fff; font-size:12px;">
            <thead><tr><th>ì´ë¦„</th><th>í•™ë²ˆ</th><th>ì´ë©”ì¼</th><th>ì¶”ê°€</th></tr></thead>
            <tbody>
              ${students.map(s => `
                <tr>
                  <td>${escapeHtml(s.name)}</td>
                  <td>${escapeHtml(s.studentId)}</td>
                  <td>${escapeHtml(s.email)}</td>
                  <td><button class="btn-success" style="padding:2px 6px; font-size:11px;" onclick="addStudentToCourse(${courseId}, '${s.studentId}')">ì„ íƒ</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        box.innerHTML = '<div class="tiny badge-red" style="padding:5px;">ì‹¤íŒ¨</div>';
      }
    }

    async function addStudentToCourse(courseId, studentIdStr) {
      try {
        const res = await axios.post('/enrollment/add', { courseId, studentIdStr });
        alert(res.data.message);
        loadEnrolledStudents(courseId); // ìˆ˜ê°•ìƒ ëª©ë¡ ê°±ì‹ 
      } catch (err) {
        alert(err.response?.data?.message || 'ì¶”ê°€ ì‹¤íŒ¨');
      }
    }

    async function removeStudentFromCourse(courseId, userId, userName) {
      if (!confirm(`'${userName}' í•™ìƒì„ ìˆ˜ê°• ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      try {
        await axios.post('/enrollment/remove', { courseId, userId });
        loadEnrolledStudents(courseId);
      } catch (err) {
        alert('ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    function fillCourseSelects(courses) {
      const baseOpt = (placeholder) => `<option value="">${placeholder}</option>`;
      const options = courses.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');

      // â˜… [ìˆ˜ì •] ë©”ì‹œì§€ìš© ì„ íƒì°½ í¬í•¨
      ['noticeCourseSelect', 'offvoteCourseSelect', 'reportCourseSelect', 'msgCourseSelect'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = baseOpt('ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”') + options;
      });
    }

    // ======================
    // â˜…â˜…â˜… [ì¶”ê°€] ë©”ì‹œì§€/ì±„íŒ… ê¸°ëŠ¥ â˜…â˜…â˜…
    // ======================
    let currentChatTargetId = null;
    let currentChatCourseId = null;
    let chatInterval = null;

    async function loadChatTargets() {
      const courseId = document.getElementById('msgCourseSelect').value;
      const targetList = document.getElementById('msgTargetList');
      const chatBox = document.getElementById('chatBox');
      
      currentChatCourseId = courseId;
      currentChatTargetId = null;
      if(chatInterval) clearInterval(chatInterval);

      if (!courseId) {
        targetList.innerHTML = '<div style="padding:15px; color:#999; text-align:center;">ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>';
        chatBox.innerHTML = '';
        return;
      }

      try {
        const res = await axios.get(`/message/targets?courseId=${courseId}`);
        const targets = res.data || [];

        if (!targets.length) {
          targetList.innerHTML = '<div style="padding:15px; color:#999; text-align:center;">ëŒ€í™” ìƒëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>(ìˆ˜ê°•ìƒì´ ì—†ê±°ë‚˜ êµìˆ˜ë‹˜ì´ ì•„ë‹™ë‹ˆë‹¤)</div>';
          return;
        }

        targetList.innerHTML = targets.map(t => `
          <div class="user-item" onclick="openChatRoom('${t.id}', '${escapeHtml(t.name)}')">
            <div style="font-weight:bold;">${escapeHtml(t.name)}</div>
            <div class="tiny muted">${t.role === 'instructor' ? 'êµìˆ˜ë‹˜' : (t.studentId || 'í•™ìƒ')}</div>
          </div>
        `).join('');
      } catch (err) {
        console.error(err);
        targetList.innerHTML = 'ì˜¤ë¥˜ ë°œìƒ';
      }
    }

    async function openChatRoom(targetId, targetName) {
      currentChatTargetId = targetId;
      
      const items = document.querySelectorAll('.user-item');
      items.forEach(el => el.classList.remove('active'));
      event.currentTarget.classList.add('active');

      const chatBox = document.getElementById('chatBox');
      chatBox.innerHTML = `<div style="text-align:center; padding:10px; color:#666;"><b>${targetName}</b>ë‹˜ê³¼ì˜ ëŒ€í™”</div>`;

      loadMessages();
      if(chatInterval) clearInterval(chatInterval);
      chatInterval = setInterval(loadMessages, 3000);
    }

    async function loadMessages() {
      if (!currentChatTargetId || !currentChatCourseId) return;
      try {
        const res = await axios.get(`/message/list?targetId=${currentChatTargetId}&courseId=${currentChatCourseId}`);
        const msgs = res.data || [];
        const chatBox = document.getElementById('chatBox');
        
        const header = chatBox.firstElementChild ? chatBox.firstElementChild.outerHTML : '';
        
        const html = msgs.map(m => {
          const isMine = (m.senderId == userId);
          const time = new Date(m.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          return `
            <div class="message-bubble ${isMine ? 'msg-mine' : 'msg-other'}">
              ${!isMine ? `<div class="msg-info">${escapeHtml(m.sender.name)}</div>` : ''}
              <div>${escapeHtml(m.content)}</div>
              <div class="msg-info" style="text-align:${isMine?'right':'left'}; margin-top:4px;">${time}</div>
            </div>
          `;
        }).join('');

        chatBox.innerHTML = header + html;
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (err) {
        console.error(err);
      }
    }

    async function sendMsg() {
      const input = document.getElementById('msgInput');
      const content = input.value;
      if (!content.trim()) return;
      if (!currentChatTargetId) { alert('ëŒ€í™” ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }

      try {
        await axios.post('/message/send', {
          receiverId: currentChatTargetId,
          courseId: currentChatCourseId,
          content: content
        });
        input.value = '';
        loadMessages();
      } catch (err) {
        alert('ì „ì†¡ ì‹¤íŒ¨');
      }
    }

    // ======================
    // â˜…â˜…â˜… [ìˆ˜ì •ë¨] ì„¸ì…˜/ì¶œì„ (ë‚ ì§œ, íœ´ê°• ì—¬ë¶€ í‘œì‹œ ì ìš©) â˜…â˜…â˜…
    // ======================
    async function toggleSessions(courseId) {
      const box = document.getElementById(`sessions-${courseId}`);
      if (!box) return;

      if (box.style.display === 'block') {
        box.style.display = 'none';
        return;
      }

      try {
        const res = await axios.get(`/sessions/${courseId}`);
        const sessions = res.data || [];
        box.style.display = 'block';

        let myStatus = {};
        if (userRole === 'student') {
          try {
            const stRes = await axios.get(`/attendance/my-status/${courseId}`);
            (stRes.data || []).forEach(x => { myStatus[x.sessionId] = x; });
          } catch(e) {}
        }

        if (!sessions.length) {
            box.innerHTML = '<p class="muted">ë“±ë¡ëœ ì£¼ì°¨ë³„ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            box.innerHTML = sessions.map(s => {
                // ë‚ ì§œì™€ ì œëª©(íœ´ê°•/ë³´ê°•) ì²˜ë¦¬
                const isHoliday = s.title && s.title.includes('íœ´ê°•');
                const titleHtml = isHoliday 
                  ? `<span style="color:#c62828; font-weight:bold;">â›” ${escapeHtml(s.title)}</span>`
                  : `<span>${escapeHtml(s.title || s.week + 'ì£¼ì°¨ ìˆ˜ì—…')}</span>`;
                  
                const dateBadge = s.date 
                  ? `<span class="tag-date">ğŸ“… ${s.date}</span>` 
                  : `<span class="tiny muted" style="margin-right:5px;">ë‚ ì§œë¯¸ì •</span>`;

                const isCode = s.attendanceType === 'code';
                const typeLabel = isCode ? 'ğŸ”¢ ì¸ì¦ë²ˆí˜¸' : 'ğŸ“¢ í˜¸ëª…(êµìˆ˜ë‹˜ í™•ì¸)';
                const statusPill = s.isOpen 
                    ? `<span class="pill badge-green">ì¶œì„ ì§„í–‰ ì¤‘</span>` 
                    : `<span class="pill muted">ë§ˆê°ë¨</span>`;

                // ë²„íŠ¼ UI
                let actionUI = '';
                
                if (userRole === 'instructor' || userRole === 'admin') {
                    if (isHoliday) {
                        actionUI = `<span class="tiny muted">íœ´ê°•ì¼ì…ë‹ˆë‹¤ (ì¶œì„ ì—†ìŒ)</span>`;
                    } else {
                        const btnText = s.isOpen ? 'â›” ë§ˆê°í•˜ê¸°' : 'â–¶ï¸ ì¶œì„ ì‹œì‘';
                        const btnClass = s.isOpen ? 'btn-danger' : 'btn-success';
                        
                        const codeDisplay = (isCode && s.isOpen)
                            ? `<span style="font-size:1.2em; font-weight:bold; color:#d32f2f; margin-right:10px;">CODE: ${s.authCode}</span>` 
                            : '';

                        const typeSelect = !s.isOpen ? `
                            <select id="changeType-${s.id}" style="width:auto; padding:2px;">
                                <option value="code" ${isCode ? 'selected' : ''}>ì¸ì¦ë²ˆí˜¸</option>
                                <option value="simple" ${!isCode ? 'selected' : ''}>í˜¸ëª…ì¶œì„</option>
                            </select>
                        ` : '';

                        actionUI = `
                            ${codeDisplay}
                            ${typeSelect}
                            <button class="${btnClass}" onclick="toggleSessionStatus(${s.id})">${btnText}</button>
                            <button class="btn-primary" onclick="toggleSessionRoster(${s.id})">ëª…ë‹¨/ì²´í¬</button>
                        `;
                    }
                } 
                else { // í•™ìƒì¸ ê²½ìš°
                    const mine = myStatus[s.id];
                    
                    if (isHoliday) {
                        actionUI = `<span class="tiny muted">íœ´ê°•</span>`;
                    }
                    else if (mine && mine.statusText && mine.statusText !== 'ë¯¸ì¶œì„') {
                        actionUI = `<span style="font-weight:900; color:${mine.color}; font-size:1.1em;">${mine.statusText}</span>`;
                    } 
                    else if (s.isOpen) {
                        if (isCode) {
                            actionUI = `
                                <div style="display:flex; gap:5px; justify-content:flex-end; align-items:center;">
                                    <input type="text" id="code-input-${s.id}" placeholder="ë²ˆí˜¸ 4ìë¦¬" style="width:80px; margin:0; text-align:center;">
                                    <button class="btn-primary" onclick="studentCheckIn(${s.id})">ì¶œì„í•˜ê¸°</button>
                                </div>
                            `;
                        } else {
                            actionUI = `<span class="badge-blue">êµìˆ˜ë‹˜ì´ ì¶œì„ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...</span>`;
                        }
                    } else {
                        actionUI = `<span class="muted">ì•„ì§ ìˆ˜ì—… ì „ì´ê±°ë‚˜ ë§ˆê°ë¨</span>`;
                    }
                }

                // ì¹´ë“œ ë Œë”ë§
                return `
                  <div class="card" style="background:${isHoliday ? '#fff5f5' : (userRole==='student'?'#fff':'#f9f9f9')}; border-left:${userRole==='student'?'4px solid #ddd':'none'}; padding:12px; margin-bottom:10px;">
                    <div class="row" style="align-items:center;">
                      <div class="col">
                        ${dateBadge}
                        <h4 style="margin:4px 0;">${titleHtml}</h4>
                        <div class="tiny muted">
                            ${!isHoliday ? `${typeLabel} | ${statusPill}` : ''}
                            ${s.startTime ? `| ì‹œì‘: ${s.startTime}` : ''}
                        </div>
                      </div>
                      <div class="col right">
                        ${actionUI}
                      </div>
                    </div>
                    <div id="roster-${s.id}" style="display:none; margin-top:10px;"></div>
                  </div>
                `;
            }).join('');
        }
      } catch (err) {
        console.error(err);
        box.style.display = 'block';
        box.innerHTML = '<p class="badge-red">ì˜¤ë¥˜ ë°œìƒ</p>';
      }
    }

    // index.html ë‚´ì˜ toggleSessionStatus í•¨ìˆ˜ë¥¼ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •
async function toggleSessionStatus(sessionId) {
    const sel = document.getElementById(`changeType-${sessionId}`);
    const attendanceType = sel ? sel.value : null;

    try {
        // ì„œë²„ì— ìƒíƒœ ë³€ê²½ ìš”ì²­
        const res = await axios.patch('/sessions/status', { sessionId, attendanceType });
        
        // ì„±ê³µ ì‹œ ë©”ì‹œì§€ë¥¼ ë„ìš°ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë°”ë€ ìƒíƒœ(ë§ˆê°í•˜ê¸° ë²„íŠ¼ ë“±)ë¥¼ ë°˜ì˜
        alert(res.data.message);
        
        // â˜… í•µì‹¬: ì‘ë‹µì„ ë°›ì€ í›„ í™•ì‹¤í•˜ê²Œ ë¡œë”©ì„ ë‹¤ì‹œ í•©ë‹ˆë‹¤.
        // ë‹¨ìˆœíˆ location.reload()ë§Œ í•˜ë©´ ë¹„ë™ê¸° ì¶©ëŒì´ ë‚  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì•„ë˜ì™€ ê°™ì´ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        window.location.reload(); 
    } catch(err) {
        console.error("ìƒíƒœ ë³€ê²½ ì—ëŸ¬:", err);
        // ì„œë²„ì—ì„œ ì´ë¯¸ ë³€ê²½ë˜ì—ˆëŠ”ë° ì—ëŸ¬ë¡œ ë¹ ì§€ëŠ” ê²½ìš°ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ 
        // ì—ëŸ¬ ë©”ì‹œì§€ê°€ 'ì´ë¯¸ ë³€ê²½ë¨'ê³¼ ê´€ë ¨ ìˆëŠ”ì§€ í™•ì¸í•˜ê±°ë‚˜ ìƒì„¸ ì—ëŸ¬ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
        if (err.response && err.response.data) {
            alert('ì‹¤íŒ¨: ' + err.response.data.message);
        } else {
            alert('ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ìƒˆë¡œê³ ì¹¨ í›„ í™•ì¸í•´ë³´ì„¸ìš”)');
        }
    }
}

    async function studentCheckIn(sessionId) {
        const input = document.getElementById(`code-input-${sessionId}`);
        const code = input ? input.value : '';

        if (!code) { alert('ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }

        try {
            const res = await axios.post('/attendance/check', { sessionId, code });
            alert(res.data.message); 
            location.reload();
        } catch (err) {
            alert(err.response?.data?.message || 'ì¶œì„ ì‹¤íŒ¨');
        }
    }

    async function toggleSessionRoster(sessionId) {
  const box = document.getElementById(`roster-${sessionId}`);
  if (!box) return;

  // 1. ì´ë¯¸ ëª…ë‹¨ì´ ì—´ë ¤ìˆë‹¤ë©´ ë‹«ê¸° (í† ê¸€ ê¸°ëŠ¥)
  if (box.style.display === 'block') {
    box.style.display = 'none';
    return;
  }

  // 2. [í•µì‹¬] ëª…ë‹¨ì„ ìƒˆë¡œ ì—´ê¸° ì „ì— ê¸°ì¡´ ë‚´ìš©ì„ ë¹„ì›Œ ì¤‘ë³µ ì¶œë ¥ì„ ë°©ì§€í•©ë‹ˆë‹¤.
  box.innerHTML = '<div class="tiny muted" style="padding:10px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  box.style.display = 'block';

  try {
    const res = await axios.get(`/attendance/session/${sessionId}`);
    const rows = res.data || [];

    if (!rows.length) {
      box.innerHTML = '<p class="muted" style="padding:10px;">ì¶œì„ ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    // ìƒíƒœ ì½”ë“œ(0~4)ë¥¼ í•œê¸€ë¡œ ë³€í™˜í•˜ëŠ” ë‚´ë¶€ í•¨ìˆ˜
    const statusName = (v) => {
      if (v == '0') return 'ë¯¸ì •';
      if (v == '1') return 'ì¶œì„';
      if (v == '2') return 'ì§€ê°';
      if (v == '3') return 'ê²°ì„';
      if (v == '4') return 'ê³µê²°';
      return String(v);
    };

    // 3. í…Œì´ë¸” ìƒì„± (innerHTMLì„ í†µì§¸ë¡œ ê°ˆì•„ë¼ìš°ë¯€ë¡œ ì¤‘ë³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)
    box.innerHTML = `
      <table style="width:100%; border-collapse: collapse; margin-top:10px; background:#fff;">
        <thead>
          <tr style="background:#f8f9fa;">
            <th style="border:1px solid #ddd; padding:8px;">ì´ë¦„</th>
            <th style="border:1px solid #ddd; padding:8px;">í•™ë²ˆ</th>
            <th style="border:1px solid #ddd; padding:8px;">í˜„ì¬ ìƒíƒœ</th>
            <th style="border:1px solid #ddd; padding:8px;">ìƒíƒœ ë³€ê²½</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr style="border-bottom:1px solid #eee;">
              <td style="padding:8px; border:1px solid #ddd;">${escapeHtml(r.student?.name || '-')}</td>
              <td style="padding:8px; border:1px solid #ddd;">${escapeHtml(r.student?.studentId || '-')}</td>
              <td style="padding:8px; border:1px solid #ddd;">
                <b style="color:${r.status == '3' ? '#c62828' : (r.status == '0' ? '#777' : '#000')}">
                  ${statusName(r.status)}
                </b>
              </td>
              <td style="padding:8px; border:1px solid #ddd;">
                <button class="btn-success" style="padding:4px 8px; font-size:11px;" 
                        data-student-id="${r.student?.id}" data-session-id="${sessionId}" 
                        onclick="changeAttendanceStatus('${r.id}', '1')">ì¶œì„</button>
                <button class="btn-warning" style="padding:4px 8px; font-size:11px;" 
                        data-student-id="${r.student?.id}" data-session-id="${sessionId}" 
                        onclick="changeAttendanceStatus('${r.id}', '2')">ì§€ê°</button>
                <button class="btn-danger"  style="padding:4px 8px; font-size:11px;" 
                        data-student-id="${r.student?.id}" data-session-id="${sessionId}" 
                        onclick="changeAttendanceStatus('${r.id}', '3')">ê²°ì„</button>
                <button class="btn-primary" style="padding:4px 8px; font-size:11px;" 
                        data-student-id="${r.student?.id}" data-session-id="${sessionId}" 
                        onclick="changeAttendanceStatus('${r.id}', '4')">ê³µê²°</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  } catch (err) {
    console.error("ëª…ë‹¨ ë¡œë”© ì—ëŸ¬:", err);
    box.innerHTML = '<p class="badge-red" style="padding:10px;">ëª…ë‹¨ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
  }
}

   async function changeAttendanceStatus(id, status) {
    if (!confirm('ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    // í´ë¦­ëœ ë²„íŠ¼(event.target)ì— ì €ì¥ëœ data- ê°’ì„ ì§ì ‘ ì½ì–´ì˜µë‹ˆë‹¤. (ê°€ì¥ ì •í™•í•œ ë°©ë²•)
    const btn = event.target;
    const studentId = btn.getAttribute('data-student-id');
    const sessionId = btn.getAttribute('data-session-id');

    try {
        // ì„œë²„ API(routes/attendance.js)ê°€ ìš”êµ¬í•˜ëŠ” ì •ë³´ë¥¼ ëª¨ë‘ ë‹´ì•„ ë³´ëƒ…ë‹ˆë‹¤.
        const res = await axios.patch(`/attendance/${id}`, { 
            status: status,
            studentId: studentId, // ì‹ ê·œ ìƒì„± ì‹œ í•„ìˆ˜
            sessionId: sessionId  // ì‹ ê·œ ìƒì„± ì‹œ í•„ìˆ˜
        });
        
        alert(res.data.message || 'ì •ì • ì™„ë£Œ');
        location.reload(); 
    } catch (err) {
        console.error("ì •ì • ì—ëŸ¬:", err);
        alert(err.response?.data?.message || 'ì •ì • ì‹¤íŒ¨: ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
    }
}

    // ======================
    // ê³µê²°
    // ======================
    const excuseForm = document.getElementById('excuseForm');
    if (excuseForm) {
      excuseForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          await axios.post('/excuse', new FormData(e.target));
          alert('ê³µê²° ì‹ ì²­ ì™„ë£Œ!');
          e.target.reset();
          loadMyExcuses();
          loadNotifications();
        } catch (err) {
          console.error(err);
          alert(err.response?.data?.message || 'ì‹ ì²­ ì‹¤íŒ¨');
        }
      });
    }

    async function loadMyExcuses() {
      try {
        const res = await axios.get('/excuse');
        const list = res.data || [];
        const box = document.getElementById('myExcuseList');
        if (!box) return;
        if (!list.length) { box.innerHTML = '<p class="muted">ê³µê²° ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
        box.innerHTML = list.map(x => `<div class="card"><div><b>ì‚¬ìœ </b>: ${escapeHtml(x.reason || '')}</div><div class="tiny muted">ìƒíƒœ: ${escapeHtml(x.status || '')}</div>${x.fileUrl ? `<div class="tiny"><a href="${x.fileUrl}" target="_blank">ì²¨ë¶€ ë³´ê¸°</a></div>` : ''}</div>`).join('');
      } catch (err) { const box = document.getElementById('myExcuseList'); if (box) box.innerHTML = '<p class="badge-red">ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>'; }
    }

    // index.html ë‚´ì˜ loadPendingExcuses í•¨ìˆ˜ë¥¼ ì•„ë˜ ì½”ë“œë¡œ êµì²´
async function loadPendingExcuses() {
  try {
    const res = await axios.get('/excuse/pending');
    const list = res.data || [];
    const box = document.getElementById('pendingExcuseList');
    if (!box) return;
    
    if (!list.length) { 
      box.innerHTML = '<p class="muted">ëŒ€ê¸° ì¤‘ì¸ ê³µê²°ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; 
      return; 
    }

    // [ìˆ˜ì •] ì¹´ë“œ ë‚´ë¶€ì— x.fileUrl í™•ì¸ ë¡œì§ì„ ì¶”ê°€í•˜ì—¬ ì¦ë¹™ ì„œë¥˜ ë§í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    box.innerHTML = list.map(x => `
      <div class="card">
        <div><b>í•™ìƒ</b>: ${escapeHtml(x.student?.name || '-')}</div>
        <div><b>ì‚¬ìœ </b>: ${escapeHtml(x.reason || '')}</div>
        <div class="tiny muted">ìƒíƒœ: ${escapeHtml(x.status || '')}</div>
        
        ${x.fileUrl ? `
          <div style="margin-top:5px; padding:5px; background:#f0f7ff; border-radius:4px;">
            <a href="${x.fileUrl}" target="_blank" style="color:#007bff; font-size:12px; font-weight:bold;">
              ğŸ“ ì¦ë¹™ ì„œë¥˜ í™•ì¸í•˜ê¸° (ìƒˆ ì°½)
            </a>
          </div>
        ` : '<div class="tiny muted">ì²¨ë¶€íŒŒì¼ ì—†ìŒ</div>'}
        
        <div class="row" style="margin-top:10px;">
          <div class="col">
            <button class="btn-success" onclick="processExcuse(${x.id}, 'approved')">ìŠ¹ì¸</button>
          </div>
          <div class="col">
            <button class="btn-danger" onclick="processExcuse(${x.id}, 'rejected')">ë°˜ë ¤</button>
          </div>
        </div>
      </div>
    `).join('');
  } catch (err) { 
    const box = document.getElementById('pendingExcuseList'); 
    if (box) box.innerHTML = '<p class="badge-red">ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>'; 
  }
}
    async function processExcuse(id, status) { try { await axios.patch(`/excuse/${id}`, { status }); alert('ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); loadPendingExcuses(); loadNotifications(); } catch (err) { alert('ì²˜ë¦¬ ì‹¤íŒ¨'); } }

    // ======================
    // ê³µì§€
    // ======================
    async function loadNotices() { try { const res = await axios.get('/notice'); const list = res.data || []; const box = document.getElementById('noticeList'); if(!box) return; if(!list.length){ box.innerHTML='<p class="muted">ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; } box.innerHTML = list.map(n => `<div class="card"><h4 style="margin:0 0 6px;">ğŸ“¢ ${escapeHtml(n.title||'')}</h4><div class="left">${escapeHtml(n.content||'')}</div><div class="tiny muted" style="margin-top:8px;">ì‘ì„±ì: ${escapeHtml(n.writer?.name||'-')}${n.course?` | ê°•ì˜: ${escapeHtml(n.course.name)}`:''} | ${new Date(n.createdAt).toLocaleString()}</div></div>`).join(''); } catch(e){ document.getElementById('noticeList').innerHTML='<p class="badge-red">ì‹¤íŒ¨</p>'; } }
    const noticeForm = document.getElementById('noticeForm'); if(noticeForm){ noticeForm.addEventListener('submit', async (e)=>{ e.preventDefault(); const courseId=document.getElementById('noticeCourseSelect')?.value; if(!courseId){alert('ê°•ì˜ì„ íƒí•„ìˆ˜');return;} try{ await axios.post('/notice',{courseId, title:e.target.title.value, content:e.target.content.value}); alert('ì™„ë£Œ'); e.target.reset(); loadNotices(); loadNotifications(); }catch(e){alert('ì‹¤íŒ¨');} }); }

    // ======================
    // íˆ¬í‘œ
    // ======================
    async function loadOffvotes() { try{ const res=await axios.get('/offvote'); const votes=res.data||[]; const box=document.getElementById('offvoteList'); if(!box)return; if(!votes.length){ box.innerHTML='<p class="muted">íˆ¬í‘œ ì—†ìŒ</p>'; return; } box.innerHTML=votes.map(v=>renderOffvoteCard(v)).join(''); }catch(e){ document.getElementById('offvoteList').innerHTML='<p class="badge-red">ì‹¤íŒ¨</p>'; } }
    function renderOffvoteCard(v) { const isClosed=!v.isOpen; const courseName=v.course?.name||''; const title=escapeHtml(v.title); const desc=escapeHtml(v.description); let footer=''; if(userRole==='student'){ const opts=(v.options||[]).map(o=>`<button class="btn-primary" style="margin:6px 6px 0 0;" onclick="submitVote(${v.id}, ${o.id})">${escapeHtml(o.text)}</button>`).join(''); footer=`<div style="margin-top:10px;">${isClosed?'<div class="muted">ì¢…ë£Œë¨</div>':opts}${isClosed?`<div style="margin-top:10px;"><button class="btn-ghost" onclick="viewOffvoteResult(${v.id})">ê²°ê³¼ë³´ê¸°</button><div id="offvote-result-${v.id}" style="margin-top:10px;display:none;"></div></div>`:''}</div>`; } else { footer=`<div style="margin-top:10px;">${!isClosed?`<button class="btn-danger" onclick="closeOffvote(${v.id})">ì¢…ë£Œ</button>`:'<span class="pill">ì¢…ë£Œë¨</span>'} <button class="btn-ghost" onclick="viewOffvoteResult(${v.id})">ê²°ê³¼ë³´ê¸°</button><div id="offvote-result-${v.id}" style="margin-top:10px;display:none;"></div></div>`; } return `<div class="card"><div class="tiny muted">ê°•ì˜: <b>${courseName}</b> ${isClosed?'<span class="pill badge-red">CLOSED</span>':'<span class="pill badge-green">OPEN</span>'}</div><h4>ğŸ“Š ${title}</h4><div class="muted">${desc}</div>${footer}</div>`; }
    const offvoteForm=document.getElementById('offvoteForm'); if(offvoteForm){ offvoteForm.addEventListener('submit', async(e)=>{ e.preventDefault(); const cid=document.getElementById('offvoteCourseSelect')?.value; const title=e.target.title.value; const desc=e.target.description.value; const opts=e.target.options.value.split('\n').map(s=>s.trim()).filter(Boolean); if(!opts.length){alert('ì˜µì…˜ì…ë ¥í•˜ì„¸ìš”');return;} try{ await axios.post('/offvote',{title, description:desc, courseId:cid, options:opts}); alert('ìƒì„±ì™„ë£Œ'); e.target.reset(); loadOffvotes(); loadNotifications(); }catch(e){alert('ì‹¤íŒ¨');} }); }
    async function submitVote(oid, optId){ try{ await axios.post(`/offvote/${oid}/vote`,{optionId:optId}); alert('íˆ¬í‘œì™„ë£Œ'); loadOffvotes(); }catch(e){alert('ì‹¤íŒ¨');} }
    async function closeOffvote(oid){ if(!confirm('ì¢…ë£Œ?'))return; try{ await axios.patch(`/offvote/${oid}/close`); alert('ì¢…ë£Œë¨'); loadOffvotes(); }catch(e){alert('ì‹¤íŒ¨');} }
    async function viewOffvoteResult(oid){ const box=document.getElementById(`offvote-result-${oid}`); if(!box)return; if(box.style.display==='block'){box.style.display='none';return;} try{ const res=await axios.get(`/offvote/${oid}/result`); const data=res.data; box.style.display='block'; const total=(data.options||[]).reduce((a,b)=>a+(b.count||0),0); box.innerHTML=`<div class="card" style="background:#fafafa; border:1px dashed #ddd;"><div class="tiny muted">ì´ íˆ¬í‘œ: <b>${total}</b></div><table><thead><tr><th>ì˜µì…˜</th><th>ë“í‘œ</th><th>%</th></tr></thead><tbody>${(data.options||[]).map(o=>{ const pct=total>0?Math.round(((o.count||0)/total)*100):0; return `<tr><td class="left">${escapeHtml(o.text)}</td><td><b>${o.count||0}</b></td><td>${pct}%</td></tr>`; }).join('')}</tbody></table></div>`; }catch(e){ box.innerHTML='ì‹¤íŒ¨'; } }

    // ======================
    // ì¶œì„ ë¦¬í¬íŠ¸ & ì•Œë¦¼ & ë¡œê·¸
    // ======================
   // index.html ë‚´ë¶€ ìŠ¤í¬ë¦½íŠ¸ì˜ í•´ë‹¹ í•¨ìˆ˜ë¥¼ ì•„ë˜ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš”.
async function loadAttendanceReport() {
    const cid = document.getElementById('reportCourseSelect')?.value;
    const box = document.getElementById('reportResult');
    if (!box) return;
    if (!cid) {
        box.innerHTML = '<p class="muted">ê°•ì˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>';
        return;
    }

    try {
        const res = await axios.get(`/attendance/stats/${cid}`);
        const rows = res.data || [];
        
        if (!rows.length) {
            box.innerHTML = '<p class="muted">ì¶œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        // [ìˆ˜ì • ì‚¬í•­] í‘œ í—¤ë”ì— 'ê³µê²°' ì¶”ê°€ ë° ë°ì´í„° í•„ë“œ ë§¤ì¹­
        box.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>ì´ë¦„</th>
                        <th>ì¶œì„</th>
                        <th>ì§€ê°</th>
                        <th>ê²°ì„</th> 
                        <th>ê³µê²°</th> <th>ì§€ê°->ê²°ì„ íšŸìˆ˜</th> 
                        <th>ìµœì¢…ê²°ì„</th>
                        <th>ì¶œì„ë¥ </th>
                    </tr>
                </thead>
                <tbody>
                    ${rows.map(r => `
                        <tr style="${r.isDanger ? 'background:#ffebee;' : ''}">
                            <td>${escapeHtml(r.name)}</td>
                            <td class="badge-blue">${r.presentCount}</td>
                            <td class="badge-orange">${r.remainingLates}</td>
                            <td class="badge-red">${r.pureAbsent}</td> 
                            <td class="badge-blue">${r.excuseCount}</td> <td class="muted">${r.conversionCount}</td> 
                            <td style="color:#c62828; font-weight:bold;">${r.finalAbsentCount}</td>
                            <td><b>${r.rate}%</b></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    } catch (e) {
        console.error("ë¦¬í¬íŠ¸ ë¡œë”© ì‹¤íŒ¨:", e);
        box.innerHTML = '<p class="badge-red">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
    }
}
    async function loadNotifications() { try{ const res=await axios.get('/notifications'); const list=res.data||[]; const box=document.getElementById('notificationList'); if(!box)return; if(!list.length){box.innerHTML='<p class="muted">ì•Œë¦¼ ì—†ìŒ</p>';return;} box.innerHTML=list.map(n=>`<div class="card ${n.isRead?'noti-read':'noti-unread'}"><div><b>${escapeHtml(n.title||'')}</b></div><div>${escapeHtml(n.message||'')}</div><div class="tiny muted" style="margin-top:6px;">${new Date(n.createdAt).toLocaleString()} ${n.isRead?'ì½ìŒ':'ìƒˆ ì•Œë¦¼'}</div>${!n.isRead?`<div style="margin-top:8px;"><button class="btn-success" onclick="markNotificationRead(${n.id})">ì½ìŒ</button></div>`:''}</div>`).join(''); }catch(e){ if(document.getElementById('notificationList')) document.getElementById('notificationList').innerHTML='ì‹¤íŒ¨'; } }
    async function markNotificationRead(id){ try{ await axios.patch(`/notifications/${id}/read`); loadNotifications(); }catch(e){} }
    async function markAllNotificationsRead(){ if(!confirm('ì „ì²´ì½ìŒ?'))return; try{ await axios.patch('/notifications/read/all'); loadNotifications(); }catch(e){} }

    // â˜…â˜…â˜… [ìˆ˜ì •ë¨] ê°ì‚¬ ë¡œê·¸ë¥¼ ë³´ê¸° ì¢‹ì€ 'í‘œ(Table)' í˜•íƒœë¡œ ì¶œë ¥í•˜ëŠ” í•¨ìˆ˜
    async function loadAuditLogs() {
      const limitInput = document.getElementById('auditLimit');
      const limit = limitInput ? limitInput.value : '';
      const q = limit ? `?limit=${limit}` : '';
      
      const box = document.getElementById('auditList');
      if (!box) return;

      box.innerHTML = '<div class="tiny muted">ë¡œê·¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>';

      try {
        // API ê²½ë¡œê°€ /audit ì¸ì§€ /admin/audit-logs ì¸ì§€ ìƒí™©ì— ë§ê²Œ í˜¸ì¶œ
        let res;
        try {
            res = await axios.get(`/admin/audit-logs${q}`);
        } catch (e) {
            res = await axios.get(`/audit${q}`);
        }

        const logs = res.data || [];

        if (!logs.length) {
          box.innerHTML = '<p class="muted">ê¸°ë¡ëœ ê°ì‚¬ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        // í…Œì´ë¸” í—¤ë” ìƒì„±
        let html = `
          <table style="width:100%; font-size:12px; table-layout: fixed;">
            <colgroup>
                <col style="width: 140px;">
                <col style="width: 100px;">
                <col style="width: 160px;">
                <col>
                <col style="width: 100px;">
            </colgroup>
            <thead>
              <tr style="background:#eee;">
                <th>ğŸ“… ì¼ì‹œ</th>
                <th>ğŸ‘¤ ìˆ˜í–‰ì</th>
                <th>âš¡ í™œë™ (Action)</th>
                <th>ğŸ“ ìƒì„¸ ë‚´ìš© (Details)</th>
                <th>ğŸŒ IP</th>
              </tr>
            </thead>
            <tbody>
        `;

        // ë¡œê·¸ ë°ì´í„° í•œ ì¤„ì”© ìƒì„±
        html += logs.map(l => {
          const time = new Date(l.createdAt).toLocaleString();
          
          // ìˆ˜í–‰ì ì •ë³´ (ì´ë¦„ + ê¶Œí•œ)
          const actorInfo = l.actor 
            ? `<b>${escapeHtml(l.actor.name)}</b><br><span class="tiny muted">(${l.actor.role})</span>` 
            : '<span class="muted">ì‹œìŠ¤í…œ</span>';

          // ìƒì„¸ ë‚´ìš© (JSON ë¬¸ìì—´ì´ë©´ ì˜ˆì˜ê²Œ ë³´ì—¬ì£¼ê¸°)
          let detailDisplay = '-';
          if (l.details) {
            try {
                // JSON íŒŒì‹± ì‹œë„
                const parsed = JSON.parse(l.details);
                // JSONì´ë©´ key: value í˜•íƒœë¡œ ê¹”ë”í•˜ê²Œ ì¶œë ¥
                detailDisplay = '<div style="text-align:left; font-family:monospace; background:#fafafa; padding:4px; border-radius:4px; overflow-x:auto;">';
                for (const [key, val] of Object.entries(parsed)) {
                    // before/afterê°€ ìˆëŠ” ê²½ìš° (ìˆ˜ì • ë¡œê·¸) ê°•ì¡°
                    if(key === 'before') detailDisplay += `<div style="color:#d32f2f;">[ì´ì „] ${JSON.stringify(val)}</div>`;
                    else if(key === 'after') detailDisplay += `<div style="color:#2e7d32;">[ë³€ê²½] ${JSON.stringify(val)}</div>`;
                    else detailDisplay += `<div><span style="color:#555;">${key}:</span> ${val}</div>`;
                }
                detailDisplay += '</div>';
            } catch (e) {
                // JSON ì•„ë‹ˆë©´ ê·¸ëƒ¥ í…ìŠ¤íŠ¸ ì¶œë ¥
                detailDisplay = `<div style="text-align:left;">${escapeHtml(l.details)}</div>`;
            }
          }

          return `
            <tr style="border-bottom:1px solid #eee;">
              <td>${time}</td>
              <td>${actorInfo}</td>
              <td style="color:#008CBA; font-weight:bold;">${escapeHtml(l.action)}</td>
              <td class="left">${detailDisplay}</td>
              <td class="tiny muted">${l.ipAddress || '-'}</td>
            </tr>
          `;
        }).join('');

        html += `</tbody></table>`;
        box.innerHTML = html;

      } catch (err) {
        console.error(err);
        box.innerHTML = '<p class="badge-red">ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    // ======================
    // [ìˆ˜ì •ë¨] í•™ê³¼ ê´€ë¦¬
    // ======================
    async function loadDepartments() {
      const box = document.getElementById('deptList');
      if (!box) return;
      try {
        const res = await axios.get('/admin/departments');
        const list = res.data || [];

        if (!list.length) {
          box.innerHTML = '<p class="muted">ë“±ë¡ëœ í•™ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        box.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>í•™ê³¼ëª…</th>
                <th>í•™ê³¼ì½”ë“œ</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${list.map(d => `
                <tr>
                  <td class="left">${escapeHtml(d.name)}</td>
                  <td>${escapeHtml(d.code || '-')}</td>
                  <td>
                    <button class="btn-warning" style="padding:6px 10px; font-size:12px;" onclick="quickUpdateDept(${d.id})">ìˆ˜ì •</button>
                    <button class="btn-danger"  style="padding:6px 10px; font-size:12px;" onclick="deleteDepartment(${d.id})">ì‚­ì œ</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error(err);
        box.innerHTML = '<p class="badge-red">í•™ê³¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>';
      }
    }

    async function createDepartment() {
      const name = document.getElementById('deptName')?.value?.trim();
      const code = document.getElementById('deptCode')?.value?.trim() || null;

      if (!name) { alert('í•™ê³¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

      try {
        await axios.post('/admin/departments', { name, code });
        alert('í•™ê³¼ ìƒì„± ì™„ë£Œ');
        document.getElementById('deptName').value = '';
        document.getElementById('deptCode').value = '';
        loadDepartments();
        loadAdminCourseOptions(); 
      } catch (err) {
        console.error(err);
        alert(err.response?.data?.message || 'í•™ê³¼ ìƒì„± ì‹¤íŒ¨');
      }
    }

    async function quickUpdateDept(id) {
      const name = prompt('ìƒˆ í•™ê³¼ëª…(ë¹„ìš°ë©´ ë³€ê²½ ì•ˆ í•¨):');
      const code = prompt('ë°”ê¿€ í•™ê³¼ì½”ë“œ(ë¹„ìš°ë©´ ë³€ê²½ ì•ˆ í•¨):');
      
      const payload = {};
      if (name !== null && name !== '') payload.name = name;
      if (code !== null && code !== '') payload.code = code;

      if (!Object.keys(payload).length) return;

      try {
        await axios.patch(`/admin/departments/${id}`, payload);
        alert('ìˆ˜ì • ì™„ë£Œ');
        loadDepartments();
        loadAdminCourseOptions();
      } catch (err) {
        console.error(err);
        alert(err.response?.data?.message || 'ìˆ˜ì • ì‹¤íŒ¨');
      }
    }

    async function deleteDepartment(id){ if(!confirm('ì‚­ì œ?'))return; try{ await axios.delete(`/admin/departments/${id}`); alert('ì™„ë£Œ'); loadDepartments(); }catch(e){alert('ì‹¤íŒ¨');} }

    // ======================
    // â˜…â˜…â˜… [ìˆ˜ì •ë¨] í•™ê¸° ê´€ë¦¬ â˜…â˜…â˜…
    // ======================
    async function loadSemesters() {
      const box = document.getElementById('semList');
      if (!box) return;

      try {
        const res = await axios.get('/admin/semesters');
        const list = res.data || [];

        if (!list.length) {
          box.innerHTML = '<p class="muted">í•™ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        // [ìˆ˜ì •] ID, í™œì„± ì»¬ëŸ¼ ì œê±° / ì´ë¦„ -> í•™ê¸°
        box.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>í•™ê¸°</th>
                <th>ê¸°ê°„</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              ${list.map(s => `
                <tr>
                  <td class="left">${escapeHtml(s.name)}</td>
                  <td>${escapeHtml(String(s.startDate || '').slice(0,10))} ~ ${escapeHtml(String(s.endDate || '').slice(0,10))}</td>
                  <td>
                    <button class="btn-warning" style="padding:6px 10px; font-size:12px;" onclick="quickUpdateSemester(${s.id})">ìˆ˜ì •</button>
                    <button class="btn-danger"  style="padding:6px 10px; font-size:12px;" onclick="deleteSemester(${s.id})">ì‚­ì œ</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error(err);
        box.innerHTML = '<p class="badge-red">í•™ê¸° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>';
      }
    }

    async function createSemester() {
      const name = document.getElementById('semName')?.value?.trim();
      const startDate = document.getElementById('semStart')?.value || null;
      const endDate = document.getElementById('semEnd')?.value || null;

      if (!name || !startDate || !endDate) {
        alert('í•™ê¸°ëª…/ì‹œì‘ì¼/ì¢…ë£Œì¼ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”');
        return;
      }

      try {
        await axios.post('/admin/semesters', { name, startDate, endDate });
        alert('í•™ê¸° ìƒì„± ì™„ë£Œ');
        document.getElementById('semName').value = '';
        document.getElementById('semStart').value = '';
        document.getElementById('semEnd').value = '';
        loadSemesters();
      } catch (err) {
        console.error(err);
        alert(err.response?.data?.message || 'í•™ê¸° ìƒì„± ì‹¤íŒ¨');
      }
    }

    async function quickUpdateSemester(id) {
      // [ìˆ˜ì •] ìƒˆ ì´ë¦„ -> ë°”ê¿€ í•™ê¸°
      const name = prompt('ë°”ê¿€ í•™ê¸°(ë¹„ìš°ë©´ ë³€ê²½ ì•ˆ í•¨):');
      const startDate = prompt('ìƒˆ ì‹œì‘ì¼(YYYY-MM-DD, ë¹„ìš°ë©´ ë³€ê²½ ì•ˆ í•¨):');
      const endDate = prompt('ìƒˆ ì¢…ë£Œì¼(YYYY-MM-DD, ë¹„ìš°ë©´ ë³€ê²½ ì•ˆ í•¨):');
      
      // [ìˆ˜ì •] í™œì„± ì—¬ë¶€ ì§ˆë¬¸ ì œê±°

      const payload = {};
      if (name !== null && name !== '') payload.name = name;
      if (startDate !== null && startDate !== '') payload.startDate = startDate;
      if (endDate !== null && endDate !== '') payload.endDate = endDate;

      if (!Object.keys(payload).length) return;

      try {
        await axios.patch(`/admin/semesters/${id}`, payload);
        alert('ìˆ˜ì • ì™„ë£Œ');
        loadSemesters();
      } catch (err) {
        console.error(err);
        alert(err.response?.data?.message || 'ìˆ˜ì • ì‹¤íŒ¨');
      }
    }

    async function deleteSemester(id){ if(!confirm('ì‚­ì œ?'))return; try{ await axios.delete(`/admin/semesters/${id}`); alert('ì™„ë£Œ'); loadSemesters(); }catch(e){alert('ì‹¤íŒ¨');} }

    async function loadSystemSettings() { const box=document.getElementById('settingsBox'); if(!box)return; try{ const res=await axios.get('/admin/settings'); const list=res.data||[]; if(!list.length){box.innerHTML='ì—†ìŒ';return;} box.innerHTML=`<table><thead><tr><th>KEY</th><th>VALUE</th></tr></thead><tbody>${list.map(s=>`<tr><td class="left"><b>${s.key}</b></td><td class="left">${escapeHtml(s.value)}</td></tr>`).join('')}</tbody></table>`; }catch(e){ box.innerHTML='ì‹¤íŒ¨'; } }
    async function updateSystemSetting(){ const k=document.getElementById('setKey').value; const v=document.getElementById('setValue').value; if(!k){alert('í‚¤ í•„ìˆ˜');return;} try{ await axios.patch('/admin/settings',{key:k, value:v}); alert('ì™„ë£Œ'); loadSystemSettings(); }catch(e){alert('ì‹¤íŒ¨');} }

    // ======================
    // â˜…â˜…â˜… [ìˆ˜ì •ë¨] ê´€ë¦¬ì: ì‚¬ìš©ì ëª©ë¡ & ê¶Œí•œ/ìˆ˜ì •/ì‚­ì œ â˜…â˜…â˜…
    // ======================
    async function loadAdminUsers() {
      const box = document.getElementById('adminUsersBox');
      if (!box) return;
      
      try {
        const res = await axios.get('/admin/users');
        const list = res.data || [];
        if (!list.length) { box.innerHTML = '<p class="muted">ì‚¬ìš©ì ì—†ìŒ</p>'; return; }

        box.innerHTML = `
          <table>
            <thead><tr><th>ì´ë¦„</th><th>ì´ë©”ì¼</th><th>í•™ë²ˆ</th><th>ì—­í• </th><th>ê´€ë¦¬</th></tr></thead>
            <tbody>
              ${list.map(u => `
                <tr>
                  <td class="left">${escapeHtml(u.name || '')}</td>
                  <td class="left">${escapeHtml(u.email || '')}</td>
                  <td>${escapeHtml(u.studentId || '')}</td>
                  <td><b>${escapeHtml(u.role || '')}</b></td>
                  <td>
                    <button class="btn-warning" style="padding:4px 8px; font-size:12px; margin-right:2px;" onclick="changeUserRole('${u.id}', '${u.role}', '${u.name}')">ê¶Œí•œ</button>
                    <button class="btn-primary" style="padding:4px 8px; font-size:12px; margin-right:2px;" 
                      onclick="editAdminUser('${u.id}', '${escapeHtml(u.name)}', '${escapeHtml(u.email)}', '${escapeHtml(u.studentId||'')}', '${u.role}')">
                      ìˆ˜ì •
                    </button>
                    <button class="btn-danger" style="padding:4px 8px; font-size:12px;" onclick="deleteAdminUser('${u.id}', '${escapeHtml(u.name)}')">ì‚­ì œ</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error(err);
        box.innerHTML = '<p class="badge-red">ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>';
      }
    }

    // [ìœ ì§€] ê¶Œí•œ ë³€ê²½ (ë¹ ë¥¸ ìŠ¤ìœ„ì¹­ìš©)
    async function changeUserRole(id, currentRole, name) {
      let newRole = (currentRole === 'student') ? 'instructor' : 'student';
      if (!['student', 'instructor'].includes(currentRole)) {
        newRole = prompt('ë³€ê²½í•  ê¶Œí•œì„ ì…ë ¥í•˜ì„¸ìš” (student / instructor / admin):', currentRole);
        if(!newRole) return;
      } else {
        if (!confirm(`'${name}' ë‹˜ì˜ ê¶Œí•œì„ [${currentRole}]ì—ì„œ [${newRole}]ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      }

      try {
        await axios.patch(`/admin/users/${id}`, { role: newRole });
        alert('ê¶Œí•œì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadAdminUsers();
        loadAdminCourseOptions();
      } catch (err) {
        console.error(err);
        alert('ê¶Œí•œ ë³€ê²½ ì‹¤íŒ¨');
      }
    }

    // â˜…â˜…â˜… [ìˆ˜ì •ë¨] ì‚¬ìš©ì ì •ë³´ ì „ì²´ ìˆ˜ì • (ì—­í•  Role ì…ë ¥ì°½ ì œê±°) â˜…â˜…â˜…
    async function editAdminUser(id, oldName, oldEmail, oldStdId, oldRole) {
      const newName = prompt("ì´ë¦„:", oldName);
      if (newName === null) return;

      const newEmail = prompt("ì´ë©”ì¼:", oldEmail);
      if (newEmail === null) return;

      const newStdId = prompt("í•™ë²ˆ:", oldStdId);
      if (newStdId === null) return;

      // ì—­í•  ì…ë ¥ ë¶€ë¶„ ì‚­ì œí•¨ (ê¶Œí•œ ë³€ê²½ì€ ë³„ë„ ë²„íŠ¼ìœ¼ë¡œ ìˆ˜í–‰)

      try {
        // ì„œë²„ ì „ì†¡ ì‹œ role í•„ë“œ ì œì™¸
        await axios.patch(`/admin/users/${id}`, {
          name: newName,
          email: newEmail,
          studentId: newStdId
        });
        alert("ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadAdminUsers();
        loadAdminCourseOptions();
      } catch (err) {
        console.error(err);
        alert(err.response?.data?.message || "ìˆ˜ì • ì‹¤íŒ¨");
      }
    }

    // [ì¶”ê°€] ì‚¬ìš©ì ì‚­ì œ
    async function deleteAdminUser(id, name) {
      if (!confirm(`ì •ë§ '${name}' ì‚¬ìš©ìë¥¼ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      try {
        await axios.delete(`/admin/users/${id}`);
        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadAdminUsers();
        loadAdminCourseOptions();
      } catch (err) {
        console.error(err);
        alert(err.response?.data?.message || 'ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    async function createAdminUser() {
      const name = document.getElementById('newUserNameUser').value;
      const email = document.getElementById('newUserEmail').value;
      const password = document.getElementById('newUserPwd').value;
      const studentId = document.getElementById('newUserStdId').value;
      const role = document.getElementById('newUserRole').value;

      if (!name || !email || !password) {
        alert('ì´ë¦„, ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
        return;
      }

      try {
        await axios.post('/admin/users', { name, email, password, studentId, role });
        alert('ì‚¬ìš©ìê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        // ì…ë ¥ì°½ ì´ˆê¸°í™”
        document.getElementById('newUserNameUser').value = '';
        document.getElementById('newUserEmail').value = '';
        document.getElementById('newUserPwd').value = '';
        document.getElementById('newUserStdId').value = '';
        loadAdminUsers();
        loadAdminCourseOptions(); // êµìˆ˜ë‹˜ ì¶”ê°€ëì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ê°±ì‹ 
      } catch (err) {
        console.error(err);
        alert(err.response?.data?.message || 'ë“±ë¡ ì‹¤íŒ¨');
      }
    }

    // â˜…â˜…â˜… [ìˆ˜ì •ë¨] ê³¼ëª© ëª©ë¡: ID ì œê±°, ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ â˜…â˜…â˜…
    async function loadAdminCourses() {
      const box = document.getElementById('adminCoursesBox');
      if(!box) return;
      try {
        const res = await axios.get('/admin/courses');
        const list = res.data || [];
        if (!list.length) { box.innerHTML = '<p class="muted">ê³¼ëª© ì—†ìŒ</p>'; return; }
        
        box.innerHTML = `
          <table>
            <thead><tr><th>ê³¼ëª©</th><th>êµìˆ˜</th><th>í•™ê³¼</th><th>í•™ê¸°</th><th>ê´€ë¦¬</th></tr></thead>
            <tbody>${list.map(c => {
              const iName = c.instructor?.name || '';
              const dName = c.department?.name || '';
              const sName = c.semester?.name || '';
              // ì¸ì ì „ë‹¬ ì‹œ ë¬¸ìì—´ ì²˜ë¦¬ë¥¼ ìœ„í•´ escape
              const safeName = escapeHtml(c.name);
              
              return `<tr>
                <td class="left">${safeName}</td>
                <td>${escapeHtml(iName)}</td>
                <td>${escapeHtml(dName)}</td>
                <td>${escapeHtml(sName)}</td>
                <td>
                  <button class="btn-primary" style="padding:4px 8px; font-size:12px; margin-right:2px;"
                    onclick="openAdminCourseEditor(${c.id}, '${safeName}', '${c.instructorId||''}', '${c.departmentId||''}', '${c.semesterId||''}')">
                    ìˆ˜ì •
                  </button>
                  <button class="btn-danger" style="padding:4px 8px; font-size:12px;" onclick="deleteAdminCourse(${c.id}, '${safeName}')">ì‚­ì œ</button>
                </td>
              </tr>`;
            }).join('')}</tbody>
          </table>
        `;
      } catch(e) { 
        console.error(e);
        box.innerHTML = '<p class="badge-red">ì‹¤íŒ¨</p>'; 
      }
    }

    // â˜…â˜…â˜… [ì¶”ê°€ë¨] ê³¼ëª© ìˆ˜ì • íŒì—… ì—´ê¸° (ì—¬ê¸°ì„œ ë°ì´í„°ë¥¼ í™•ì‹¤í•˜ê²Œ ë¶ˆëŸ¬ì˜´!) â˜…â˜…â˜…
    async function openAdminCourseEditor(id, name, instrId, deptId, semId) {
      document.getElementById('courseEditCard').style.display = 'block';
      document.getElementById('editCourseId').value = id;
      document.getElementById('editCourseName').value = name;

      // 1. ë°ì´í„°ë¥¼ í™•ì‹¤í•˜ê²Œ ìƒˆë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
      try {
        // ë³‘ë ¬ë¡œ API í˜¸ì¶œí•´ì„œ ë°ì´í„°ë¥¼ ë‹¤ ê°€ì ¸ì˜´
        const [uRes, dRes, sRes] = await Promise.all([
           axios.get('/admin/users'),
           axios.get('/admin/departments'),
           axios.get('/admin/semesters')
        ]);

        // 2. êµìˆ˜ë‹˜ ì„¸íŒ…
        const instructors = uRes.data.filter(u => u.role === 'instructor');
        const iSel = document.getElementById('editCourseInstructor');
        iSel.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' +
           instructors.map(u => `<option value="${u.id}" ${u.id == instrId ? 'selected' : ''}>${u.name} (${u.email})</option>`).join('');

        // 3. í•™ê³¼ ì„¸íŒ…
        const dSel = document.getElementById('editCourseDept');
        dSel.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' +
           dRes.data.map(d => `<option value="${d.id}" ${d.id == deptId ? 'selected' : ''}>${d.name}</option>`).join('');

        // 4. í•™ê¸° ì„¸íŒ…
        const sSel = document.getElementById('editCourseSem');
        sSel.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' +
           sRes.data.map(s => `<option value="${s.id}" ${s.id == semId ? 'selected' : ''}>${s.name}</option>`).join('');

      } catch(e) {
        console.error(e);
        alert('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨');
      }

      location.href = "#courseEditCard";
    }

    function closeCourseEditor() {
      document.getElementById('courseEditCard').style.display = 'none';
    }

    // â˜…â˜…â˜… [ì¶”ê°€ë¨] ê³¼ëª© ìˆ˜ì • ì €ì¥ â˜…â˜…â˜…
    async function saveCourseChanges() {
      const id = document.getElementById('editCourseId').value;
      const name = document.getElementById('editCourseName').value;
      const instructorId = document.getElementById('editCourseInstructor').value;
      const departmentId = document.getElementById('editCourseDept').value;
      const semesterId = document.getElementById('editCourseSem').value;

      if(!id) return;

      try {
        await axios.patch(`/admin/courses/${id}`, {
          name, 
          instructorId: instructorId || null,
          departmentId: departmentId || null,
          semesterId: semesterId || null
        });
        alert('ê³¼ëª© ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeCourseEditor();
        loadAdminCourses(); // ëª©ë¡ ê°±ì‹ 
      } catch(err) {
        console.error(err);
        alert(err.response?.data?.message || 'ìˆ˜ì • ì‹¤íŒ¨');
      }
    }

    // â˜…â˜…â˜… [ì¶”ê°€ë¨] ê³¼ëª© ì‚­ì œ â˜…â˜…â˜…
    async function deleteAdminCourse(id, name) {
      if(!confirm(`ì •ë§ '${name}' ê³¼ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìˆ˜ê°•ìƒ, ì¶œì„ê¸°ë¡ ë“± ëª¨ë‘ ì‚­ì œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)`)) return;
      try {
        await axios.delete(`/admin/courses/${id}`);
        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadAdminCourses();
      } catch(err) {
        console.error(err);
        alert(err.response?.data?.message || 'ì‚­ì œ ì‹¤íŒ¨');
      }
    }

    async function loadAdminReport() { const box=document.getElementById('adminReportBox'); if(!box)return; try{ const res=await axios.get('/admin/reports/stats'); const d=res.data||{}; box.innerHTML=`<div class="card" style="background:#fafafa;"><div><b>ìš”ì•½</b></div><div class="row" style="margin-top:10px;"><div class="col">User:${d.users}</div><div class="col">Course:${d.courses}</div><div class="col">Attend:${d.attendances}</div></div></div>`; }catch(e){ box.innerHTML='ì‹¤íŒ¨'; } }

    function escapeHtml(str) { if(str===null||str===undefined)return ''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'", "&#039;"); }

    // â˜…â˜…â˜… [ì¤‘ìš”] ê´€ë¦¬ì ì½”ìŠ¤ ì˜µì…˜ ë¡œë”© (ì•ˆì „ì¥ì¹˜ ì¶”ê°€) â˜…â˜…â˜…
    // í•˜ë‚˜ê°€ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ëŠ” ëœ¨ë„ë¡ try-catch ë¶„ë¦¬
    // â˜…â˜…â˜… [ìˆ˜ì •ë¨] ê´€ë¦¬ì ì½”ìŠ¤ ì˜µì…˜ ë¡œë”© (ì•ˆì „ì¥ì¹˜ ì¶”ê°€)
    // ê¸°ì¡´ í•¨ìˆ˜ë¥¼ ì§€ìš°ê³  ì´ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
    async function loadAdminCourseOptions() {
      console.log("ì˜µì…˜ ë¡œë”© ì‹œì‘...");

      // 1. êµìˆ˜ë‹˜ ë¶ˆëŸ¬ì˜¤ê¸° (ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°)
      try {
        const res = await axios.get('/admin/users');
        // roleì´ instructorì¸ ì‚¬ëŒë§Œ í•„í„°ë§
        const instructors = (res.data || []).filter(u => u.role === 'instructor');
        const el = document.getElementById('newCourseInstructor');
        
        // ìš”ì†Œê°€ í™”ë©´ì— ìˆì„ ë•Œë§Œ ì‹¤í–‰ (ì—ëŸ¬ ë°©ì§€)
        if (el) {
           el.innerHTML = '<option value="">êµìˆ˜ë‹˜ì„ ì„ íƒí•˜ì„¸ìš”</option>' + 
            instructors.map(u => `<option value="${u.id}">${u.name} (${u.email})</option>`).join('');
        }
      } catch (e) { console.error("êµìˆ˜ë‹˜ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨", e); }

      // 2. í•™ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°
      try {
        const res = await axios.get('/admin/departments');
        const el = document.getElementById('newCourseDept');
        if (el) {
           el.innerHTML = '<option value="">í•™ê³¼ ì„ íƒ (ì„ íƒì‚¬í•­)</option>' + 
            (res.data || []).map(d => `<option value="${d.id}">${d.name}</option>`).join('');
        }
      } catch (e) { console.error("í•™ê³¼ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨", e); }

      // 3. í•™ê¸° ë¶ˆëŸ¬ì˜¤ê¸°
      try {
        const res = await axios.get('/admin/semesters');
        const el = document.getElementById('newCourseSem');
        if (el) {
           el.innerHTML = '<option value="">í•™ê¸° ì„ íƒ (ì„ íƒì‚¬í•­)</option>' + 
            (res.data || []).map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }
      } catch (e) { console.error("í•™ê¸° ëª©ë¡ ë¡œë”© ì‹¤íŒ¨", e); }
    }
    // ê³¼ëª© ìƒì„± (ìŠ¤ë§ˆíŠ¸ ìŠ¤ì¼€ì¤„ëŸ¬)
    // â˜…â˜…â˜… [ìˆ˜ì •ë¨] ê°•ì˜ ìƒì„± (ìš”ì¼/ë‚ ì§œ í¬í•¨ + ì—ëŸ¬ ë°©ì§€) â˜…â˜…â˜…
    async function createAdminCourse() {
      const name = document.getElementById('newCourseName').value;
      const instructorId = document.getElementById('newCourseInstructor').value;
      const departmentId = document.getElementById('newCourseDept').value;
      const semesterId = document.getElementById('newCourseSem').value;
      
      // ìƒˆë¡œ ì¶”ê°€ëœ ìš”ì¼/ë‚ ì§œ ê°’ ê°€ì ¸ì˜¤ê¸° (í™”ë©´ì— ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
      const dayEl = document.getElementById('newCourseDay');
      const startEl = document.getElementById('newCourseStart');
      
      // ê°’ì´ ì—†ìœ¼ë©´ ê°ê° 1(ì›”ìš”ì¼), 2025-09-01ë¡œ ì„¤ì •
      const dayOfWeek = dayEl ? dayEl.value : 1;
      const startDate = startEl ? startEl.value : '2025-09-01';

      if (!name || !instructorId) { alert('ê³¼ëª©ëª…ê³¼ êµìˆ˜ë‹˜ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }

      try {
        await axios.post('/admin/courses', {
          name, instructorId, departmentId, semesterId,
          dayOfWeek, startDate // ì„œë²„ë¡œ ì „ì†¡
        });
        alert('ê³¼ëª© ë° ì¼ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
        
        // ì…ë ¥ì°½ ì´ˆê¸°í™”
        document.getElementById('newCourseName').value = '';
        
        // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        loadAdminCourses(); 
      } catch (err) { 
        console.error(err);
        alert('ì‹¤íŒ¨: ' + (err.response?.data?.message || err.message)); 
      }
    }
    async function saveSystemSettings() {
        const lateToAbsent = document.getElementById('lateToAbsentInput')?.value;
        const warningThreshold = document.getElementById('warningThresholdInput')?.value;

        if (!lateToAbsent || !warningThreshold) {
            alert('ëª¨ë“  ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            // ì´ì „ì— ìˆ˜ì •í•œ admin.jsì˜ bulk API ì£¼ì†Œë¡œ ë°ì´í„°ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
            const res = await axios.post('/admin/settings/bulk', {
                lateToAbsent: parseInt(lateToAbsent),
                warningThreshold: parseInt(warningThreshold)
            });

            alert(res.data.message || 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            if (typeof loadAuditLogs === 'function') loadAuditLogs(); // ë¡œê·¸ ê°±ì‹ 
        } catch (e) {
            alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }
  </script>
</body>
</html>